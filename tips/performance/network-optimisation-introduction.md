# Introduction to network processing

## ユーザーの待ち時間の大半はフロントエンドで最適化できる

ブラウザがページを表示するまでに必要な時間は、URL から HTML を取得するまでと、HTML に応じてサブリソースを取得してページを表示するまでの 2 つに分類できます。

ナビゲーションが起こると、HTML を取得するために指定の URL へリクエストを行います。HTML がブラウザに返されるまではサーバ側の処理が走っていて、ブラウザはページの構築に必要な HTML がないので、白い画面を表示することになります。

### 表示が遅くなる原因はサブリソースの取得

一般的にサーバの処理にはそこまで時間は必要なく、HTML の記述に応じて発生するサブリソースの取得が、ページの表示を遅らせている場合がほとんどです。サブリソースの取得にもサーバは関わり、API リクエストなどはサーバ処理の時間を考慮しますが、どのアセットにリクエストするかを決めるのはフロントエンドの実装です。

### HTML に応じて発生するリクエスト

ブラウザは HTML を受け取ると、CSS や画像など、サブリソースのリクエストを数十数百と繰り返すことで、ページを描画します。フロントエンド視点の最適化が、ページロードの高速化に大きくつながります。

## ネットワーク処理最適化の原則

### 量を小さく

転送コストはデータの量に比例するので、リソースは圧縮や最適化を施し、できる限り小さくします。

### 回数を少なく

HTTP/1 ではブラウザからリクエストする回数を減らすことが、ページロードの短縮につながります。HTTP/2 ではリクエスト処理が効率化されます。リクエストの回数を減らすことは有効ですが、HTTP/1 前提の静的リソースの結合は基本的に効果的ではありません。

### 距離を短く

通信するデバイスとサーバとの物理的な距離が短いほど、リクエストを送信してから応答が返ってくるラウンドトリップタイムが短くなります。

## ネットワークから取得するリソース

### テキスト - HTML / CSS / JavaScript / SVG

テキストはもっとも基本的な要素です。HTML、CSS、JavaScript、SVG など、これらのテキストは空白や改行を取り除く最小化を自動化しておきます。

### 画像 - JPEG / PNG / GIF / WebP

画像はネットワーク処理でやりとりされる総量において、ほかのリソースに比べて大きな比率を占めていルことが多いです。画像の品質を維持しつつ、ファイルサイズをなるべく小さくするには画像の特徴に応じた画像形式の選択と、画像データの圧縮と最適化を自動化することが必要です。

### Web フォント

Web フォントは、フォントファイルを配信して CSS から参照します。文字 1 つ 1 つのデータを持っていて日本語などのグリフが多い限度だとファイルサイズが大きくなりがちという問題があります。必要な文字のみを読み込むダイナミックフォント（adobe）かスプライトフォント（google）の利用を検討します。

## クリティカルレンダリングパス

ページロード中のブラウザで最初のレンダリング処理が行われるまでに必要な一連の処理をクリティカルレンダリングパスと呼んでいて、この処理を最適化することがロード速度の改善につながります。クリティカルと呼ぶのは、前の処理が終わらないとあとの処理を始められない処理の流れがあるからです。

### 1. HTML ドキュメントのダウンロードと評価

ブラウザは HTML ドキュメントを取得するためサーバに対してリクエストを行います。リクエストを受け取ったサーバは、静的ファイルの HTML や、サーバサイドで動的に生成した HTML をブラウザにレスポンスします。ブラウザは取得した HTML ドキュメントを、ファイルの先頭から順にパースして評価を行います。この過程で DOM ツリーや CSSOM ツリーの構築が行われ、外部ファイルを参照している要素の記述に基づいて HTTP リクエストを繰り返します。この時点で DOM ツリーや CSSOM ツリーは構築途中であるため、レンダリング処理は開始されません。

### 2. サブリソースのダウンロードと評価

CSS と JavaScript のロード中は、DOM ツリーや CSSOM ツリーに影響を与える可能性があるので、レンダリング処理をブロックして待機させます。この間、ブラウザはレンダーツリーの構築の前に、CSS や JavaScript の処理を順番に完了させようとします。クリティカルレンダリングパスでは、断片化した CSS や JavaScript を複数読み込んでいるとき、問題になりやすいです。

### 3. レンダーツリーの構築とレンダリング

DOM ツリーと CSSOM ツリーが構築されると、それを組み合わせてレンダーツリーが構築されます。これにはレンダリング対象の要素の配置や、見た目の情報が含まれていて、そこから画面上の要素位置の計算が行われ、画面上にピクセルを配置する処理が行われるとレンダリングされたことになります。ページロードの観点で言うと、レンダーツリーの構築以降は最適化できる余地がないので、構築以前の HTML やサブリソースのダウンロードと評価を最適化して、なるたけ早くレンダーツリーの構築を始めさせるかが重要です。

### フィルムストリップによるレンダリング過程の確認

レンダリングの進捗を計測するには、DevTools のフィルムストリップを使います。DevTools の Performance パネルの Screenshots をチェックした状態で計測すると、ブラウザ内部で発生するさまざまな処理の記録や連続キャプチャを実行します。

経過時間ごとにキャプチャされた画像が一覧で、ネットワーク処理がタイムラインで表示されて、各種リソースのダウンロード状況とレンダリング状況の相関を確認できます。
